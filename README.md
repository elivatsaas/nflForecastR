# nflForecastR

NFL game prediction and analysis tools in R, focused on predicting point differentials and analyzing betting lines. This package provides comprehensive utilities for preparing NFL data, training prediction models, and evaluating betting opportunities.

## ⚠️ Important Disclaimer

This package is provided for informational and educational purposes only. Any predictions, analyses, or insights generated by nflForecastR should not be considered as gambling or betting advice. Sports betting involves significant risk and can lead to financial losses. Users of this package assume full responsibility for:

- Any decisions made based on the package's outputs
- Compliance with all applicable local, state, and federal laws regarding sports betting
- Any financial losses that may occur from betting activities

The authors and contributors of nflForecastR are not responsible for any losses, damages, or legal issues that may arise from using this package for betting purposes. If you have a gambling problem, please call 1-800-GAMBLER for support.

## Features

- Data preparation and maintenance for NFL game statistics
- Multiple modeling approaches with cross-validation (Linear Models, Random Forests)
- Automated betting line analysis
- Customizable visualization tools
- Live odds integration via the-odds-api.com

## Installation

```r
# Install development version from GitHub
# install.packages("devtools")
devtools::install_github("elivatsaas/nflForecastR")
```

## Setting the Odds API Key

To retrieve live betting lines you need an API key from
[the-odds-api.com](https://the-odds-api.com/). Set it via one of the
following methods:

### macOS/Linux
```bash
export ODDS_API_KEY="your_key_here"
```

### Windows (PowerShell)
```powershell
setx ODDS_API_KEY "your_key_here"
```

### In R
```r
Sys.setenv(ODDS_API_KEY = "your_key_here")
```

## Running Tests and Documentation

Use the helper script to regenerate documentation and execute all tests:

```bash
Rscript scripts/run_all_tests.R
```

## Core Data Sets

### tidy_weekly
Week-by-week team performance metrics (2015-2023):
- Offensive metrics (EPA, points, rushing/passing)
- Defensive metrics (EPA, points allowed)
- QB performance (completion %, passer rating)
- Efficiency stats (3rd down %, red zone %)
- Cumulative season statistics

```r
# Quick look at 2023 Chiefs data
library(nflForecastR)
library(dplyr)

kc_data <- tidy_weekly %>%
  filter(posteam == "KC", season == 2023) %>%
  select(week, off_epa, def_epa, points_scored)
```

### tidy_games
Game-level dataset optimized for prediction:
- Pre-game team statistics
- Vegas lines (spreads and totals)
- Game outcomes
- Divisional matchup indicators

```r
# View recent games
recent_games <- tidy_games %>%
  filter(season == 2023) %>%
  select(season, week, home_team, away_team, 
         point_differential, away.spread_line)
```

## Modeling Workflow

```r
library(nflForecastR)
library(ranger)

# 1. Build weekly and game data for 2019-2024
weekly <- update_weekly(2019:2024, replace_existing = TRUE)
games  <- prepare_games(start_year = 2019, end_year = 2024, weekly_data = weekly)

# 2. Train on 2019-2023, hold out 2024
train_games <- subset(games, season <= 2023)
test_games  <- subset(games, season == 2024)

# 3. Evaluate multiple formulas with cross-validation
formulas <- list(
  point_differential ~ home.qb_passer_rating + away.qb_passer_rating,
  point_differential ~ home.off_epa + away.def_epa + home.rest - away.rest
)

evaluate_formula <- function(f) {
  lm_res <- lm_cv(f, train_games, k = 5, seed = 42)
  rf_res <- rf_cv(f, train_games, k = 5, seed = 42)
  rbind(
    data.frame(formula = deparse(f), model = "lm", lm_res$average_metrics),
    data.frame(formula = deparse(f), model = "rf", rf_res$average_metrics)
  )
}

results <- do.call(rbind, lapply(formulas, evaluate_formula))
print(results)

# 4. Fit best model on all training data
best <- results[which.max(results$SpreadAccuracy), ]
best_formula <- as.formula(best$formula)
if (best$model == "lm") {
  final_model <- lm(best_formula, data = train_games)
} else {
  final_model <- ranger::ranger(best_formula, data = train_games, num.trees = 500)
}

# 5. Predict 2024 games and visualize
pred_2024 <- predict_with_model(test_games, final_model, training_data = train_games)
head(pred_2024)

# 6. Optional: backtest 2019-2024 walk-forward
bt <- backtest_model(years = 2019:2024, model_type = best$model, formula = best_formula)
bt$overall_metrics

# 7. Prepare upcoming week and plot predictions
upcoming <- prepare_predictions(weekly)
future_preds <- predict_with_model(upcoming, final_model, training_data = train_games)
create_prediction_plot(future_preds)
```
## Key Functions

### Data Preparation
- `prepare_weekly()`: Process weekly team statistics
- `prepare_games()`: Create game-level prediction dataset
- `calculate_means()`: Compute rolling averages and season means
- `update_weekly()` / `update_games()`: Update datasets with new games

### Modeling
- `lm_cv()`: Linear model with cross-validation
- `rf_cv()`: Random forest with cross-validation
- `evaluate_formula()`: Assess model variable importance
- `predict_with_model()`: Generate and format predictions

### Visualization
- `create_prediction_plot()`: Create visual game predictions


## License

This project is licensed under the MIT License.

## Acknowledgments

Built using data from:
- nflfastR (play-by-play data)
- the-odds-api.com (live betting odds)
